pip install pytrends pandas openpyxl requests xlrd

import time
import requests
import pandas as pd
from pytrends.request import TrendReq

# Google Trends setup
pytrends = TrendReq(hl='ru-RU', tz=180)

def safe_get(url, params=None, headers=None, retries=3, backoff=1.0):
    for attempt in range(retries):
        try:
            r = requests.get(url, params=params, headers=headers, timeout=15)
            r.raise_for_status()
            return r
        except Exception:
            if attempt + 1 == retries:
                raise
            time.sleep(backoff * (attempt + 1))

def get_google_trends_related(keyword, geo='RU', timeframe='today 12-m'):
    results = []
    try:
        pytrends.build_payload([keyword], cat=0, timeframe=timeframe, geo=geo)
        related = pytrends.related_queries().get(keyword)
        if related:
            top = related.get('top')
            if top is not None:
                for _, row in top.iterrows():
                    results.append({
                        "Ключевая фраза": row["query"],
                        "Источник": "Google Trends",
                        "Популярность (справочно)": row.get("value", None)
                    })
    except Exception as e:
        print(f"[Google Trends] error for '{keyword}': {e}")
    return results

def get_google_suggest(keyword, hl="ru"):
    url = "http://suggestqueries.google.com/complete/search"
    params = {
        "client": "firefox",
        "hl": hl,
        "q": keyword
    }
    headers = {
        "User-Agent": "keyword-agent/1.0"
    }
    try:
        r = safe_get(url, params=params, headers=headers)
        suggestions = r.json()[1]
        return [{"Ключевая фраза": s, "Источник": "Google Suggest", "Популярность (справочно)": None}
                for s in suggestions]
    except Exception as e:
        print(f"[Google Suggest] error for '{keyword}': {e}")
        return []

def get_yandex_suggest(keyword, lang="ru"):
    url = "https://suggest.yandex.net/suggest-ya.cgi"
    params = {
        "part": keyword,
        "lang": lang,
        "uil": lang,
        "v": "4",
        "search_type": "suggest"
    }
    headers = {
        "User-Agent": "keyword-agent/1.0"
    }
    try:
        r = safe_get(url, params=params, headers=headers)
        suggestions = r.json()[1]
        return [{"Ключевая фраза": s, "Источник": "Yandex Suggest", "Популярность (справочно)": None}
                for s in suggestions]
    except Exception as e:
        print(f"[Yandex Suggest] error for '{keyword}': {e}")
        return []

STYLE_KEYWORDS = {
    "реализм": ["реализм", "реалист", "реалистич"],
    "абстракция": ["абстракц", "абстракт"],
    "пейзаж": ["пейзаж", "ландшафт"],
    "портрет": ["портрет"],
    "масло": ["маслом", "маслян"],
    "графика": ["график", "графика"],
    "современное": ["современн", "современная"]
}

INTENT_KEYWORDS = {
    "купить": ["купить", "куплю", "продажа", "заказ"],
    "заказать": ["заказать", "сделать на заказ"],
    "в интерьере": ["интерьер", "для интерьера", "в интерьере"],
    "в подарок": ["подарок", "в подарок", "подарить"],
    "выбрать": ["выбрать", "подобрать"]
}

def classify_phrase(phrase):
    phrase_l = phrase.lower()
    topics = []
    intents = []
    for t, tokens in STYLE_KEYWORDS.items():
        for tk in tokens:
            if tk in phrase_l:
                topics.append(t)
                break
    for i, tokens in INTENT_KEYWORDS.items():
        for tk in tokens:
            if tk in phrase_l:
                intents.append(i)
                break
    topic = ", ".join(topics) if topics else ""
    intent = ", ".join(intents) if intents else ""
    audience = ""
    if "купить" in phrase_l or "продажа" in phrase_l or "куплю" in phrase_l:
        audience = "Покупатели"
    elif "для интерьера" in phrase_l or "интерьер" in phrase_l:
        audience = "Декораторы / владельцы жилья"
    elif "подарок" in phrase_l:
        audience = "Покупатели подарков"
    return topic, intent, audience

def keyword_agent(seeds,
                  output_file="keywords_output.xlsx",
                  use_trends=True,
                  use_google_suggest=True,
                  use_yandex_suggest=True,
                  sleep_between=0.8):
    collected = []
    seen = set()

    for seed in seeds:
        seed = seed.strip()
        if not seed:
            continue

        if use_trends:
            trends = get_google_trends_related(seed)
            for rec in trends:
                phrase = rec["Ключевая фраза"].strip()
                key = (phrase, rec["Источник"])
                if key not in seen:
                    seen.add(key)
                    topic, intent, audience = classify_phrase(phrase)
                    rec.update({"Тема": topic, "Целевая аудитория": audience, "Intent_tags": intent})
                    collected.append(rec)
            time.sleep(sleep_between)

        if use_google_suggest:
            gs = get_google_suggest(seed)
            for rec in gs:
                phrase = rec["Ключевая фраза"].strip()
                key = (phrase, rec["Источник"])
                if key not in seen:
                    seen.add(key)
                    topic, intent, audience = classify_phrase(phrase)
                    rec.update({"Тема": topic, "Целевая аудитория": audience, "Intent_tags": intent})
                    collected.append(rec)
            time.sleep(sleep_between)

        if use_yandex_suggest:
            ys = get_yandex_suggest(seed)
            for rec in ys:
                phrase = rec["Ключевая фраза"].strip()
                key = (phrase, rec["Источник"])
                if key not in seen:
                    seen.add(key)
                    topic, intent, audience = classify_phrase(phrase)
                    rec.update({"Тема": topic, "Целевая аудитория": audience, "Intent_tags": intent})
                    collected.append(rec)
            time.sleep(sleep_between)

    df = pd.DataFrame(collected)
    cols = ["Ключевая фраза", "Источник", "Тема", "Intent_tags", "Целевая аудитория", "Популярность (справочно)"]
    for c in cols:
        if c not in df.columns:
            df[c] = ""
    df = df[cols]
    df.to_excel(output_file, index=False)
    print(f"Saved {len(df)} rows to {output_file}")
    return df

if __name__ == "__main__":
    seeds = [
        "картины",
        "живопись",
        "графика",
        "покупка картин",
        "искусство",
        "художник"
    ]
    keyword_agent(seeds)
